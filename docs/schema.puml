@startuml DocumentSharing

' Styling
skinparam componentStyle rectangle
skinparam component {
    ArrowThickness 1
}
skinparam linetype ortho

' ========== TABLES ==========

class User {
    - id : int [PK]
    - username : string [UNIQUE, INDEXED]
    - first_name : string [NULLABLE]
    - last_name : string [NULLABLE]
    - password : string
    - email : string [UNIQUE, INDEXED]
    - verified : bool [DEFAULT: false]
    - secret : string [DEFAULT: gen_random_uuid]
    - created_at : datetime
    - updated_at : datetime
    ____
        **Relationships**
        # documents: list[Document]
        # memberships: list[GroupMembership]
        # annotations: list[Annotation]
        # groups: list[Group] (viewonly, via GroupMembership)
}

class Group {
    - id : int [PK]
    - name : string [UNIQUE, INDEXED]
    - secret : string [DEFAULT: gen_random_uuid]
    - created_at : datetime
    - updated_at : datetime
    ____
        **Relationships**
        # owner: User (viewonly, via GroupMembership, role=owner)
        # documents: list[Document]
        # memberships: list[GroupMembership]
    ____
        **Column Properties**
        # member_count: int
}

enum Permission {
    administrator
    add_annotations
    view_public_annotations
    view_public_annotation_user
    view_restricted_annotations
    view_restricted_annotation_user
    manage_members
    manage_permissions
    upload_documents
    delete_documents
    modify_documents
}

class GroupMembership {
    - user_id : int [PK, FK]
    - group_id : int [PK, FK]
    - permissions: set<Permission>
    - created_at : datetime
    - updated_at : datetime
    ____
        **Relationships**
        # user: User
        # group: Group
}

class Document {
    - id : int [PK]
    - s3_key : string
    - size_bytes : int [DEFAULT: 0]
    - user_id : int [FK, NULLABLE]
    - group_id : int [FK, NULLABLE]
    - secret : uuid
    - created_at : datetime
    - updated_at : datetime
    ____
        **Relationships**
        # user: User [nullable]
        # group: Group [nullable]
        # annotations: list[Annotation]
    ____
        **Constraints**
        # owner_xor: user_id XOR group_id
}

enum VisibilityType {
    private
    restricted
    public
}

class Annotation {
    - id : int [PK]
    - document_id : int [FK]
    - user_id : int [FK, NULLABLE]
    - anon_id : uuid
    - anon_alias : string [NULLABLE]
    - type : VisibilityType
    - line : int
    - length : int
    - comment : string
    - created_at : datetime
    - updated_at : datetime
    ____
        **Relationships**
        # document: Document
        # user: User [nullable]
}

' ========== RELATIONSHIPS ==========

User "1" -r-> "*" Document
User "1" -r-> "*" GroupMembership
User "1" -r-> "*" Annotation

Group "1" -u-> "*" GroupMembership
Group "1" -r-> "*" Document

Document "1" -d-> "*" Annotation

GroupMembership -[hidden]r-> Permission

Annotation -[hidden]r-> VisibilityType

@enduml
